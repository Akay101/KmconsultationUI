<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Krishna Medicose | Pharmacy Consultation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #20504e;
        --muted: #94a3b8;
        --success: #16a34a;
        --danger: #dc2626;
      }

      * {
        box-sizing: border-box;
        font-family: Inter, sans-serif;
      }
      body {
        margin: 0;
        background: linear-gradient(135deg, #f8fffe, #eef7f6);
      }
      .container {
        max-width: 980px;
        margin: auto;
        padding: 40px 16px;
      }
      .card {
        background: #fff;
        border-radius: 18px;
        padding: 28px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      }
      h1 {
        color: var(--primary);
      }
      label {
        font-size: 13px;
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
      }
      input,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 14px;
      }
      textarea {
        min-height: 90px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
      }
      .slots {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .slot {
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid #cbd5e1;
        cursor: pointer;
        font-size: 13px;
      }
      .slot.active {
        background: var(--primary);
        color: white;
      }
      .slot.disabled {
        background: #f1f5f9;
        color: var(--muted);
        cursor: not-allowed;
      }
      .btn {
        padding: 14px 28px;
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #20504e, #2b7a77);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
      .center {
        text-align: center;
      }
      .success {
        color: var(--success);
        font-weight: 600;
      }
      .error {
        color: var(--danger);
        font-size: 13px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1 class="center">Krishna Medicose</h1>
      <p class="center">Book a pharmacy consultation for ₹99</p>

      <!-- BOOKING -->
      <div class="card" id="bookingCard">
        <div class="grid">
          <div><label>Name</label><input id="nameInput" /></div>
          <div><label>Email</label><input id="emailInput" type="email" /></div>
          <div><label>Phone</label><input id="phoneInput" /></div>
          <div><label>Purpose</label><input id="purposeInput" /></div>
          <div><label>Source</label><input id="sourceInput" /></div>
          <div><label>Date</label><input id="dateInput" type="date" /></div>
        </div>

        <div style="margin-top: 14px">
          <label>Description</label>
          <textarea id="descriptionInput"></textarea>
        </div>

        <div style="margin-top: 18px">
          <label>Select Slot</label>
          <div class="slots" id="slots"></div>
          <p id="slotLoader" style="font-size: 13px; color: var(--muted)"></p>
        </div>

        <div class="center" style="margin-top: 24px">
          <button class="btn" id="bookBtn">Pay & Book Slot</button>
        </div>
      </div>

      <!-- UPI -->
      <div class="card hidden center" id="upiCard">
        <h2>Complete Payment</h2>
        <p>Pay ₹99 to</p>
        <h3 style="color: var(--primary)">9639191817@ptyes</h3>

        <p style="margin-top: 20px">Enter UTR</p>
        <input id="utrInput" />
        <p id="utrError" class="error"></p>

        <button class="btn" style="margin-top: 16px" id="confirmBtn">
          Confirm Payment
        </button>
      </div>

      <!-- SUCCESS -->
      <div class="card hidden center" id="successCard">
        <h2 class="success">✅ Booking Confirmed</h2>
        <p>You will receive confirmation on email.</p>
      </div>
    </div>

    <script>
      /* ========= CONFIG ========= */
      const BASE_URL = "https://api.krishnamedicose.in";
      let selectedSlotId = null;
      let appointmentId = null;

      /* ========= ELEMENTS ========= */
      const nameInput = document.getElementById("nameInput");
      const emailInput = document.getElementById("emailInput");
      const phoneInput = document.getElementById("phoneInput");
      const purposeInput = document.getElementById("purposeInput");
      const sourceInput = document.getElementById("sourceInput");
      const descriptionInput = document.getElementById("descriptionInput");
      const dateInput = document.getElementById("dateInput");
      const slotsEl = document.getElementById("slots");
      const slotLoader = document.getElementById("slotLoader");

      /* ========= INIT ========= */
      dateInput.min = new Date().toISOString().split("T")[0];
      dateInput.value = dateInput.min;
      fetchSlots(dateInput.value);
      dateInput.onchange = () => fetchSlots(dateInput.value);

      document.getElementById("bookBtn").onclick = bookAppointment;
      document.getElementById("confirmBtn").onclick = confirmPayment;

      /* ========= FUNCTIONS ========= */
      async function fetchSlots(date) {
        slotsEl.innerHTML = "";
        slotLoader.innerText = "Loading slots...";
        selectedSlotId = null;

        try {
          const res = await fetch(
            `${BASE_URL}/api/slots/available?date=${date}`
          );

          const result = await res.json();
          slotLoader.innerText = "";

          if (!result.success || !Array.isArray(result.data)) {
            slotLoader.innerText = "No slots available";
            return;
          }

          const slots = result.data;

          if (slots.length === 0) {
            slotLoader.innerText = "No slots available";
            return;
          }

          slots.forEach((slot) => {
            const div = document.createElement("div");
            div.className = "slot";

            const start = new Date(slot.startTime).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });
            const end = new Date(slot.endTime).toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });

            div.innerText = `${start} - ${end}`;

            if (slot.isBooked) {
              div.classList.add("disabled");
            } else {
              div.onclick = () => {
                document
                  .querySelectorAll(".slot")
                  .forEach((s) => s.classList.remove("active"));
                div.classList.add("active");
                selectedSlotId = slot._id;
              };
            }

            slotsEl.appendChild(div);
          });
        } catch (err) {
          console.error(err);
          slotLoader.innerText = "Failed to load slots";
        }
      }

      async function bookAppointment() {
        console.log("Book clicked");

        if (!selectedSlotId) {
          alert("Select a slot");
          return;
        }

        const payload = {
          name: nameInput.value.trim(),
          email: emailInput.value.trim(),
          phoneNumber: phoneInput.value.trim(),
          purpose: purposeInput.value.trim(),
          source: sourceInput.value.trim(),
          description: descriptionInput.value.trim(),
          timeSlot: selectedSlotId,
        };

        const res = await fetch(`${BASE_URL}/api/appointments/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        console.log("BOOK RESPONSE:", data);

        if (!data.success) {
          alert(data.message || "Booking failed");
          return;
        }

        appointmentId = data.appointmentId;
        document.getElementById("bookingCard").classList.add("hidden");
        document.getElementById("upiCard").classList.remove("hidden");
      }

      async function confirmPayment() {
        if (!appointmentId) {
          alert("Invalid appointment");
          return;
        }

        const utr = document.getElementById("utrInput").value.trim();
        if (!/^\d{10,20}$/.test(utr)) {
          document.getElementById("utrError").innerText = "Invalid UTR";
          return;
        }

        const res = await fetch(
          `${BASE_URL}/api/appointments/${appointmentId}/confirm-upi`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ utr }),
          }
        );

        const data = await res.json();
        if (data.success) {
          document.getElementById("upiCard").classList.add("hidden");
          document.getElementById("successCard").classList.remove("hidden");
        }
      }
    </script>
  </body>
</html>
