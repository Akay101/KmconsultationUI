<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Krishna Medicose | Pharmacy Consultation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#020617;
      --card:#0f172a;
      --primary:#6366f1;
      --secondary:#22d3ee;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#ef4444;
      --success:#22c55e;
    }

    *{box-sizing:border-box;font-family:Inter,sans-serif}
    body{margin:0;background:radial-gradient(circle at top,#1e1b4b,#020617);color:var(--text)}
    section{padding:90px 16px}
    .container{max-width:1200px;margin:auto}
    h1{font-size:56px}
    h2{font-size:36px}
    p{color:var(--muted);line-height:1.7}

    .btn{
      padding:14px 32px;border-radius:999px;
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      color:#020617;font-weight:600;border:none;cursor:pointer
    }

    .card{
      background:linear-gradient(180deg,#0f172a,#020617);
      padding:30px;border-radius:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.6)
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:18px
    }

    label{font-size:13px;font-weight:600;margin-bottom:6px;display:block}
    input,textarea{
      width:100%;padding:12px 14px;border-radius:12px;
      border:1px solid #1f2937;background:#020617;color:white
    }

    .slots{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .slot{
      padding:10px 14px;border-radius:999px;
      border:1px solid #1f2937;cursor:pointer;font-size:13px
    }
    .slot.active{
      background:linear-gradient(90deg,var(--primary),var(--secondary));
      color:#020617;border:none
    }
    .slot.disabled{opacity:.4;cursor:not-allowed}

    .hidden{display:none}
    .center{text-align:center}

    footer{
      padding:40px;text-align:center;
      color:var(--muted);border-top:1px solid #1f2937
    }
  </style>
</head>

<body>

<!-- ================= BOOKING PAGE ================= -->
<div id="page-book">

<section class="center">
  <div class="container">
    <h1>Krishna <span style="background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Medicose</span></h1>
    <p>Personalised pharmacy consultation for students & professionals</p>
  </div>
</section>

<section>
  <div class="container">
    <div class="card">
      <h2>Book Consultation ₹99</h2>

      <div class="grid">
        <div><label>Name</label><input id="nameInput"></div>
        <div><label>Email</label><input id="emailInput" type="email"></div>
        <div><label>Phone</label><input id="phoneInput"></div>
        <div><label>Purpose</label><input id="purposeInput"></div>
        <div><label>Source</label><input id="sourceInput"></div>
        <div><label>Date</label><input id="dateInput" type="date"></div>
      </div>

      <div style="margin-top:14px">
        <label>Description</label>
        <textarea id="descriptionInput"></textarea>
      </div>

      <div style="margin-top:20px">
        <label>Select Slot</label>
        <div class="slots" id="slots"></div>
        <p id="slotLoader"></p>
      </div>

      <div class="center" style="margin-top:30px">
        <button class="btn" onclick="bookAppointment()">Pay & Book Slot</button>
      </div>
    </div>
  </div>
</section>

</div>

<!-- ================= PAYMENT PAGE ================= -->
<div id="page-pay" class="hidden">

<section class="center">
  <div class="container">
    <div class="card">
      <h2>Complete Payment</h2>
      <p>Pay <b>₹99</b> to</p>
      <h1 style="background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
        9639191817@ptyes
      </h1>

      <p id="timer" style="color:var(--danger);font-weight:600"></p>

      <input id="utrInput" placeholder="Enter UTR">
      <p id="utrError" style="color:var(--danger)"></p>

      <button class="btn" onclick="confirmPayment()">Confirm Payment</button>
    </div>
  </div>
</section>

</div>

<!-- ================= SUCCESS ================= -->
<div id="page-success" class="hidden center">
  <section>
    <div class="container">
      <h1 style="color:var(--success)">✅ Booking Confirmed</h1>
      <p>You will receive confirmation on email.</p>
    </div>
  </section>
</div>

<footer>
  © 2026 Krishna Medicose
</footer>

<script>
const BASE_URL = "https://api.krishnamedicose.in";
let selectedSlotId=null, appointmentId=null, timerInterval=null;

/* ---------- ROUTER ---------- */
function route(){
  const hash = location.hash;
  document.querySelectorAll("[id^='page-']").forEach(p=>p.classList.add("hidden"));
  if(hash==="#/pay") document.getElementById("page-pay").classList.remove("hidden");
  else if(hash==="#/success") document.getElementById("page-success").classList.remove("hidden");
  else document.getElementById("page-book").classList.remove("hidden");
}
window.addEventListener("hashchange",route);
route();

/* ---------- FORM ---------- */
const dateInput=document.getElementById("dateInput");
dateInput.min=new Date().toISOString().split("T")[0];
dateInput.value=dateInput.min;
fetchSlots(dateInput.value);
dateInput.onchange=()=>fetchSlots(dateInput.value);

async function fetchSlots(date){
  const slotsEl=document.getElementById("slots");
  slotsEl.innerHTML="Loading...";
  const res=await fetch(`${BASE_URL}/api/slots/available?date=${date}`);
  const data=await res.json();
  slotsEl.innerHTML="";
  data.data.forEach(s=>{
    const d=document.createElement("div");
    d.className="slot";
    d.innerText=new Date(s.startTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})+
      " - "+new Date(s.endTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if(!s.isBooked){
      d.onclick=()=>{document.querySelectorAll(".slot").forEach(x=>x.classList.remove("active"));d.classList.add("active");selectedSlotId=s._id;}
    } else d.classList.add("disabled");
    slotsEl.appendChild(d);
  });
}

/* ---------- BOOK ---------- */
async function bookAppointment(){
  if(!selectedSlotId) return alert("Select a slot");

  const payload={
    name:nameInput.value,email:emailInput.value,phoneNumber:phoneInput.value,
    purpose:purposeInput.value,source:sourceInput.value,
    description:descriptionInput.value,timeSlot:selectedSlotId
  };

  const res=await fetch(`${BASE_URL}/api/appointments/book`,{
    method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)
  });
  const data=await res.json();
  if(!data.success) return alert(data.message);

  appointmentId=data.appointmentId;
  location.hash="#/pay";
  startTimer(120);
}

/* ---------- TIMER ---------- */
function startTimer(seconds){
  clearInterval(timerInterval);
  let remaining=seconds;
  timerInterval=setInterval(()=>{
    document.getElementById("timer").innerText=`Time remaining: ${remaining}s`;
    if(--remaining<0){
      clearInterval(timerInterval);
      alert("Payment time expired");
      location.hash="#/";
    }
  },1000);
}

/* ---------- CONFIRM ---------- */
async function confirmPayment(){
  const utr=document.getElementById("utrInput").value.trim();
  if(!/^\d{10,20}$/.test(utr)) return;

  const res=await fetch(`${BASE_URL}/api/appointments/${appointmentId}/confirm-upi`,{
    method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({utr})
  });
  const data=await res.json();
  if(data.success){
    clearInterval(timerInterval);
    location.hash="#/success";
  }
}
</script>

</body>
</html>
